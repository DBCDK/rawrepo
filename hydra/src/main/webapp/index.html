<!DOCTYPE html>
<!--
  ~ Copyright Dansk Bibliotekscenter a/s. Licensed under GNU GPL v3
  ~  See license text at https://opensource.dbc.dk/licenses/gpl-3.0
  -->

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hydra</title>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/3.6.0/superagent.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>
</head>
<body>
<div id="webapp" class="container-fluid">
    <script>
        const e = React.createElement;

        class RestCall extends React.Component {
            constructor(props) {
                super(props);
                this.queueModeInput = 0;
                this.queueModeValidated = 10;
                this.queueModeProcessing = 20;
                this.queueModeProcessed = 30;

                this.modeIntrospect = "INTROSPECT";
                this.modeQueue = "QUEUE";
                this.modeRawrepo = "RAWREPO";
                this.modeUpdate = "UPDATE";

                this.state = {
                    mode: null,
                    queueMode: this.queueModeInput,
                    queueAnalysis: null,
                    queueChunks: null,
                    queueChunkIndex: 0,
                    queueProgress: 0,
                    queueDoContinue: true,
                    queueTypes: [],
                    sessionId: null,
                    providers: [],
                    selectedQueueType: null,
                    selectedAgencies: '',
                    selectedProvider: null,
                    includeDeleted: "false",
                    isLoading: false,
                    instanceName: null,

                    statRecordByAgency: [],
                    statQueueByAgency: [],
                    statQueueByWorker: [],
                    statQueueByError: [],

                    loadingStatRecordByAgency: false,
                    loadingStatQueueByAgency: false,
                    loadingStatQueueByWorker: false,
                    loadingStatQueueByError: false
                };

                this.getQueueTypes = this.getQueueTypes.bind(this);
                this.getLibrariesByCatalogingTemplateSet = this.getLibrariesByCatalogingTemplateSet.bind(this);
                this.getRRProviders = this.getRRProviders.bind(this);
                this.handleQueueValidate = this.handleQueueValidate.bind(this);
                this.handleQueueProcess = this.handleQueueProcess.bind(this);
                this.handleQueueProcessStop = this.handleQueueProcessStop.bind(this);
                this.setQueuePage = this.setQueuePage.bind(this);
                this.setIntrospectPage = this.setIntrospectPage.bind(this);
                this.setUpdatePage = this.setUpdatePage.bind(this);
                this.setRawrepoPage = this.setRawrepoPage.bind(this);
                this.drawSubPage = this.drawSubPage.bind(this);
                this.drawQueuePage = this.drawQueuePage.bind(this);
                this.drawRawrepoPage = this.drawRawrepoPage.bind(this);
                this.onChangeQueueType = this.onChangeQueueType.bind(this);
                this.onChangeProvider = this.onChangeProvider.bind(this);
                this.onChangeIncludeDeleted = this.onChangeIncludeDeleted.bind(this);
                this.onChangeAgencies = this.onChangeAgencies.bind(this);
                this.setDefaultQueueValues = this.setDefaultQueueValues.bind(this);
                this.getProvidersLink = this.getProvidersLink.bind(this);
                this.getSubmitButtonLabel = this.getSubmitButtonLabel.bind(this);
                this.getProcessButtonLabel = this.getProcessButtonLabel.bind(this);
                this.getInstanceName = this.getInstanceName.bind(this);
                this.getHeader = this.getHeader.bind(this);
                this.getStatRecordByAgency = this.getStatRecordByAgency.bind(this);
                this.getStatQueueByWorker = this.getStatQueueByWorker.bind(this);
                this.getStatQueueByAgency = this.getStatQueueByAgency.bind(this);
                this.getStatQueueByError = this.getStatQueueByError.bind(this);
                this.setQueueModeInput = this.setQueueModeInput.bind(this);
                this.processQueue = this.processQueue.bind(this);
                this.getStopButtonLabel = this.getStopButtonLabel.bind(this);
            }

            getQueueTypes() {
                superagent.get("api/queue/types").end((err, res) => {
                    this.setState({queueTypes: JSON.parse(res.text)}, this.setDefaultQueueValues);
                });
            }

            getLibrariesByCatalogingTemplateSet(value) {
                this.state.catalogingTemplateSet = value;
                superagent.get("api/library/catalogingTemplateSet/" + catalogingTemplateSet).end((err, res) => {
                    this.setState({allowedLibraries: JSON.parse(res.text).values});
                });
            }

            getRRProviders() {
                superagent.get('api/queue/providers').end((err, res) => {
                    let providers = JSON.parse(res.text);
                    let providerNames = [];
                    providers.map(function (item, index) {
                        providerNames.push(item.name);
                    });
                    this.setState({providers: providerNames}, this.setDefaultQueueValues);
                });
            }

            getStatRecordByAgency() {
                this.setState({loadingStatRecordByAgency: true});
                superagent.get("api/stats/recordByAgency").end((err, res) => {
                    this.setState({
                        statRecordByAgency: JSON.parse(res.text),
                        loadingStatRecordByAgency: false
                    });
                });
            }

            getStatQueueByAgency() {
                this.setState({loadingStatQueueByWorker: true});
                superagent.get("api/stats/queueByAgency").end((err, res) => {
                    this.setState({statQueueByAgency: JSON.parse(res.text), loadingStatQueueByWorker: false});
                });
            }

            getStatQueueByWorker() {
                this.setState({loadingStatQueueByAgency: true});
                superagent.get("api/stats/queueByWorker").end((err, res) => {
                    this.setState({statQueueByWorker: JSON.parse(res.text), loadingStatQueueByAgency: false});
                });
            }

            getStatQueueByError() {
                this.setState({loadingStatQueueByError: true});
                superagent.get("api/stats/queueByError").end((err, res) => {
                    this.setState({statQueueByError: JSON.parse(res.text), loadingStatQueueByError: false});
                });
            }

            getInstanceName() {
                superagent.get('api/hydra/instance').end((err, res) => {
                    this.setState({instanceName: JSON.parse(res.text).value})
                });
            }

            getHeader() {
                if (this.state.instanceName === null) {
                    this.getInstanceName();
                    return 'RawRepo HYDRA';
                } else {
                    return 'RawRepo HYDRA - ' + this.state.instanceName;
                }
            }

            handleQueueValidate(event) {
                this.setState({isLoading: true});
                let data = JSON.stringify({
                    provider: this.state.selectedProvider,
                    queueType: this.state.selectedQueueType,
                    includeDeleted: this.state.includeDeleted,
                    agencyText: this.state.selectedAgencies
                });
                superagent
                    .post('api/queue/validate')
                    .send(data)
                    .type('json')
                    .set('Accept', 'application/json')
                    .then((res) => {
                        let response = res.body;

                        if (response === null) {
                            alert('FEJL!\n\n' +
                                'Der kom tomt svar tilbage');
                        } else if (response.validated === undefined) {
                            alert('FEJL!\n\n' +
                                'Der gik et eller andet galt, da svaret ikke indeholder de forventede attributter');
                        } else if (!response.validated) {
                            alert('VALIDERING FEJLEDE!\n\n' +
                                response.message);
                        } else {
                            this.setState({
                                queueMode: this.queueModeValidated,
                                queueAnalysis: response.agencyAnalysisList,
                                queueChunks: response.chunks,
                                sessionId: response.sessionId
                            });
                        }
                        this.setState({isLoading: false});
                    })
                    .catch((error) => {
                        alert('FEJL! ' + error);
                        this.setState({isLoading: false});
                    });
                event.preventDefault();
            }

            handleQueueProcess(event) {
                this.setState({isLoading: true, queueMode: this.queueModeProcessing, queueDoContinue: true});

                let chunks = this.state.queueChunks;

                this.processQueue(chunks, 0);

                event.preventDefault();
            }

            handleQueueProcessStop(event) {
                this.setState({queueDoContinue: false});

                event.preventDefault();
            }

            processQueue(chunks, chunkIndex) {
                superagent
                    .post('api/queue/process')
                    .send(JSON.stringify({
                        chunkIndex: chunkIndex,
                        sessionId: this.state.sessionId
                    }))
                    .type('json')
                    .set('Accept', 'application/json')
                    .then((res) => {
                        let response = res.body;

                        if (response === null) {
                            alert('FEJL!\n\n' +
                                'Der kom tomt svar tilbage');
                        } else if (response.validated === undefined) {
                            alert('FEJL!\n\n' +
                                'Der gik et eller andet galt, da svaret ikke indeholder de forventede attributter');
                        } else if (!response.validated) {
                            this.setState({
                                queueMode: this.queueModeValidated
                            });
                            alert('VALIDERING FEJLEDE!\n\n' +
                                response.message);
                        } else {
                            if (chunkIndex === chunks) {
                                this.setState({
                                    queueMode: this.queueModeProcessed,
                                    queueProgress: 100
                                });
                            } else {
                                this.setState({
                                    queueProgress: (chunkIndex + 1) / chunks * 100
                                });
                                if (this.state.queueDoContinue) {
                                    this.processQueue(chunks, chunkIndex + 1);
                                } else {
                                    this.setState({
                                        queueMode: this.queueModeValidated
                                    });
                                }
                            }
                        }
                        this.setState({isLoading: false});
                    })
                    .catch((error) => {
                        alert('FEJL! ' + error);
                        this.setState({
                            isLoading: false
                        });
                    });
            }

            onChangeQueueType(event) {
                this.setState({selectedQueueType: event.target.value});
            }

            onChangeProvider(event) {
                this.setState({selectedProvider: event.target.value});
            }

            onChangeIncludeDeleted(event) {
                this.setState({includeDeleted: event.target.value});
            }

            onChangeAgencies(event) {
                this.setState({selectedAgencies: event.target.value});
            }

            getStopButtonLabel(event) {
                if (this.state.queueDoContinue) {
                    return 'Stop';
                } else {
                    return 'Stopper...'
                }
            }

            setDefaultQueueValues() {
                if (this.state.selectedProvider === null && this.state.providers.length > 0) {
                    this.setState({selectedProvider: this.state.providers[0]})
                }

                if (this.state.selectedQueueType === null && this.state.queueTypes.length > 0) {
                    this.setState({selectedQueueType: this.state.queueTypes[0].key})
                }
            }

            setQueuePage() {
                this.setState({mode: this.modeQueue, queueMode: this.queueModeInput});

                this.getQueueTypes();
                this.getRRProviders();
                this.setDefaultQueueValues();
            }

            setIntrospectPage() {
                this.setState({mode: this.modeIntrospect});
            }

            setUpdatePage() {
                this.setState({mode: this.modeUpdate});
            }

            setRawrepoPage() {
                this.setState({mode: this.modeRawrepo});

                this.getStatRecordByAgency();
                this.getStatQueueByWorker();
                this.getStatQueueByAgency();
                this.getStatQueueByError();
            }

            drawSubPage() {
                if (this.state.mode === this.modeQueue) {
                    return this.drawQueuePage();
                } else if (this.state.mode === this.modeRawrepo) {
                    return this.drawRawrepoPage();
                }
            }

            getProvidersLink() {
                if (!this.state.isLoading) {
                    return e('a', {className: "toDoc", href: "providers.html", target: "_blank"}, "Forklaring");
                } else {
                    return e('p', null, "Forklaring");
                }
            }

            getSubmitButtonLabel() {
                if (!this.state.isLoading) {
                    return 'Valider';
                } else {
                    return 'Arbejder...'
                }
            }

            getProcessButtonLabel() {
                if (!this.state.isLoading) {
                    return 'Processer';
                } else {
                    return 'Arbejder...'
                }
            }

            setQueueModeInput() {
                this.setState({
                    queueMode: this.queueModeInput,
                    queueAnalysis: null,
                    queueChunks: null,
                    queueChunkIndex: 0,
                    queueProgress: 0
                })
            }

            drawQueuePage() {
                return e('div', {className: 'container'},
                    e('h2', null, 'Queue'),
                    e('form', {className: 'form-horizontal', onSubmit: this.handleQueueValidate},
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'select-queue-type',
                                className: 'control-label col-sm-2'
                            }, 'Vælg køtype:'),
                            e('div', {className: 'col-sm-8'},
                                e('select', {
                                        id: 'select-queue-type',
                                        className: 'form-control',
                                        name: 'select-queue-type',
                                        onChange: this.onChangeQueueType,
                                        value: this.state.selectedQueueType,
                                        required: true,
                                        disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                    },
                                    this.state.queueTypes.map(function (item, index) {
                                            return e('option', {key: item.key, value: item.key}, item.description);
                                        }
                                    )
                                )
                            )
                        ),
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'select-provider',
                                className: 'control-label col-sm-2'
                            }, 'Vælg provider:'),
                            e('div', {className: 'col-sm-8'},
                                e('select', {
                                        id: 'select-provider',
                                        className: 'form-control',
                                        name: 'select-provider',
                                        onChange: this.onChangeProvider,
                                        value: this.state.selectedProvider,
                                        required: true,
                                        disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                    },
                                    this.state.providers.map(function (name, index) {
                                            return e('option', {key: index, value: name}, name);
                                        }
                                    )
                                )
                            ),
                            this.getProvidersLink()
                        ),
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'select-deleted',
                                className: 'control-label col-sm-2'
                            }, 'Inkluder slettede poster?'),
                            e('div', {className: 'col-sm-8'},
                                e('select', {
                                        id: 'select-deleted',
                                        className: 'form-control',
                                        name: 'select-deleted',
                                        value: this.state.includeDeleted,
                                        onChange: this.onChangeIncludeDeleted,
                                        required: true,
                                        disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                    },
                                    [e('option', {key: 'delete-yes', value: true}, 'Ja'),
                                        e('option', {key: 'delete-no', value: false}, 'Nej')]
                                )
                            )
                        ),
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'agencies-to-queue',
                                className: 'control-label col-sm-2'
                            }, 'Indtast biblioteksnumrene:'),
                            e('div', {className: 'col-sm-8'},
                                e('textarea', {
                                    className: 'form-control',
                                    name: 'agencies-to-queue',
                                    id: 'agencies-to-queue',
                                    rows: 15,
                                    onChange: this.onChangeAgencies,
                                    value: this.state.selectedAgencies,
                                    required: true,
                                    disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                }, null)
                            )
                        ),
                        e('div', {className: 'form-group'},
                            e('div', {className: 'col-sm-offset-2 col-sm-10'},
                                e('button', {
                                    className: 'btn btn-success',
                                    type: 'submit',
                                    disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                }, this.getSubmitButtonLabel()),
                                this.state.queueMode >= this.queueModeValidated ? e('button', {
                                    className: 'btn btn-default',
                                    type: 'button',
                                    onClick: this.setQueueModeInput,
                                    disabled: this.state.isLoading || this.state.queueMode >= this.queueModeProcessing
                                }, 'Tilbage') : null
                            )
                        )
                    ),
                    this.state.queueMode >= this.queueModeValidated ?
                        e('div', null,
                            e('hr', null, null),
                            e('h2', null, 'Analyse'),
                            e('form', {className: 'form-horizontal', onSubmit: this.handleQueueProcess},
                                e('div', {className: 'container col-sm-offset-2 col-sm-8'},
                                    e('table', {className: 'table'},
                                        e('thead', null,
                                            e('tr', {key: 'queue-analysis-head'},
                                                e('th', null, 'Biblioteksnummer'),
                                                e('th', null, 'Antal')
                                            )
                                        ),
                                        e('tbody', null,
                                            this.state.queueAnalysis.map(function (item, index) {
                                                return e('tr', {key: 'queue-analysis-' + item.agencyId},
                                                    e('td', null, item.agencyId),
                                                    e('td', null, item.count)
                                                );
                                            })
                                        )
                                    )
                                ),
                                e('div', {className: 'form-group'},
                                    e('div', {className: 'col-sm-offset-2 col-sm-10'},
                                        e('button', {
                                            className: 'btn btn-success',
                                            type: 'submit',
                                            disabled: this.state.isLoading || this.state.queueMode >= this.queueModeProcessing
                                        }, this.getProcessButtonLabel())
                                    )
                                )
                            )
                        ) : null,
                    this.state.queueMode >= this.queueModeProcessing ?
                        e('div', null,
                            e('hr', null, null),
                            e('h2', null, 'Progress: ' + (Math.round(this.state.queueProgress * 100) / 100) + '%'),
                            e('form', {className: 'form-horizontal', onSubmit: this.handleQueueProcessStop},
                                e('div', {className: 'form-group'},
                                    e('div', {className: 'col-sm-offset-2 col-sm-10'},
                                        e('button', {
                                            className: 'btn btn-success',
                                            type: 'submit',
                                            disabled: this.state.queueMode !== this.queueModeProcessing
                                        }, this.getStopButtonLabel())
                                    )
                                )
                            )
                        ) : null,
                    this.state.queueMode === this.queueModeProcessed ?
                        e('div', null,
                            e('hr', null, null),
                            e('h2', null, 'Køpålæggelse færdig!'),
                            e('form', {className: 'form-horizontal', onSubmit: this.setQueueModeInput},
                                e('div', {className: 'form-group'},
                                    e('div', {className: 'col-sm-offset-2 col-sm-10'},
                                        e('button', {
                                            className: 'btn btn-success',
                                            type: 'submit',
                                            disabled: this.state.isLoading
                                        }, "Ny køpålæggelse")
                                    )
                                )
                            )
                        ) : null,
                );
            }

            drawRawrepoPage() {
                return e('div', null,
                    e('div', {className: 'row'},
                        e('div', {className: 'col-sm-6 container'},
                            e('h2', null, 'Postoversigt'),
                            e('btn', {
                                className: 'btn btn-success',
                                type: 'submit',
                                disabled: this.state.loadingStatRecordByAgency,
                                onClick: () => {
                                    this.getStatRecordByAgency()
                                }
                            }, 'Genindlæs'),
                            e('table', {className: 'table'},
                                e('thead', null,
                                    e('tr', null,
                                        e('th', null, 'Biblioteksnummer'),
                                        e('th', null, 'Antal marcxchange poster'),
                                        e('th', null, 'Antal enrichment poster')
                                    )
                                ),
                                e('tbody', null,
                                    this.state.statRecordByAgency.length === 0 ? "Indlæser..." :
                                        this.state.statRecordByAgency.map(function (item, index) {
                                                return e('tr', {key: 'stats-record-by-agency-' + index},
                                                    e('td', null, item.agencyId),
                                                    e('td', null, item.marcxCount),
                                                    e('td', null, item.enrichmentCount)
                                                );
                                            }
                                        )
                                )
                            )
                        ),
                        e('div', {className: 'col-sm-6 container'},
                            e('h2', null, 'Køoversigt - workers'),
                            e('btn', {
                                className: 'btn btn-success',
                                type: 'submit',
                                disabled: this.state.loadingStatQueueByAgency,
                                onClick: () => {
                                    this.getStatQueueByWorker()
                                }
                            }, 'Genindlæs'),
                            e('table', {className: 'table'},
                                e('thead', null,
                                    e('tr', null,
                                        e('th', null, 'Worker'),
                                        e('th', null, 'Antal'),
                                        e('th', null, 'Ajourdato')
                                    )
                                ),
                                e('tbody', null,
                                    this.state.statQueueByWorker.length === 0 ?
                                        e('tr', {key: 'stats-queue-by-worker-none'}, null,
                                            e('td', {colSpan: 3}, "Ingen"))
                                        :
                                        this.state.statQueueByWorker.map(function (item, index) {
                                                return e('tr', {key: 'stats-queue-by-worker-' + index},
                                                    e('td', null, item.text),
                                                    e('td', null, item.count),
                                                    e('td', null, item.date)
                                                );
                                            }
                                        )
                                )
                            ),
                            e('hr', null, null),
                            e('h2', null, 'Køoversigt - biblioteker'),
                            e('btn', {
                                className: 'btn btn-success',
                                type: 'submit',
                                disabled: this.state.loadingStatQueueByWorker,
                                onClick: () => {
                                    this.getStatQueueByAgency()
                                }
                            }, 'Genindlæs'),
                            e('table', {className: 'table'},
                                e('thead', null,
                                    e('tr', null,
                                        e('th', null, 'Biblioteksnummer'),
                                        e('th', null, 'Antal'),
                                        e('th', null, 'Ajourdato')
                                    )
                                ),
                                e('tbody', null,
                                    this.state.statQueueByAgency.length === 0 ?
                                        e('tr', {key: 'stats-queue-by-agency-none'}, null,
                                            e('td', {colSpan: 3}, "Ingen"))
                                        :
                                        this.state.statQueueByAgency.map(function (item, index) {
                                                return e('tr', {key: 'stats-queue-by-agency-' + index},
                                                    e('td', null, item.text),
                                                    e('td', null, item.count),
                                                    e('td', null, item.date)
                                                );
                                            }
                                        )
                                )
                            ),
                            e('hr', null, null),
                            e('h2', null, 'Køoversigt - fejlede jobs'),
                            e('btn', {
                                className: 'btn btn-success',
                                type: 'submit',
                                disabled: this.state.loadingStatQueueByError,
                                onClick: () => {
                                    this.getStatQueueByError()
                                }
                            }, 'Genindlæs'),
                            e('table', {className: 'table'},
                                e('thead', null,
                                    e('tr', null,
                                        e('th', null, 'Fejlbesked'),
                                        e('th', null, 'Antal'),
                                        e('th', null, 'Ajourdato')
                                    )
                                ),
                                e('tbody', null,
                                    this.state.statQueueByError.length === 0 ?
                                        e('tr', {key: 'stats-queue-by-error-none'}, null,
                                            e('td', {colSpan: 3}, "Ingen"))
                                        :
                                        this.state.statQueueByError.map(function (item, index) {
                                                return e('tr', {key: 'stats-queue-by-error-' + index},
                                                    e('td', null, item.text),
                                                    e('td', null, item.count),
                                                    e('td', null, item.date)
                                                );
                                            }
                                        )
                                )
                            )
                        )
                    )
                );
            }

            render() {
                return e('div', null,
                    e('h1', {
                        id: 'h1-div-headline',
                        title: 'Hydra: Multi headed beast guarding the entrance to the Underworld'
                    }, this.getHeader()),
                    e('hr'),
                    e('div', null, 'Vælg venligst en funktion:'),
                    e('button', {
                        id: 'btn-queue',
                        className: "btn btn-success",
                        style: {margin: "10px", display: 'inline-block'},
                        onClick: () => {
                            this.setQueuePage()
                        }
                    }, 'Queue'),
                    e('button', {
                        id: 'btn-introspect',
                        className: "btn btn-success",
                        style: {margin: "10px", display: 'inline-block'},
                        disabled: true,
                        onClick: () => {
                            this.setIntrospectPage()
                        }
                    }, 'Introspect'),
                    e('button', {
                        id: 'btn-update',
                        className: "btn btn-success",
                        style: {margin: "10px", display: 'inline-block'},
                        disabled: true,
                        onClick: () => {
                            this.setUpdatePage()
                        }
                    }, 'Update'),
                    e('button', {
                        id: 'btn-rawrepo',
                        className: "btn btn-success",
                        style: {margin: "10px", display: 'inline-block'},
                        onClick: () => {
                            this.setRawrepoPage()
                        }
                    }, 'Rawrepo'),
                    e('hr'),
                    this.drawSubPage());
            }
        }

        ReactDOM.render(
            e(RestCall),
            document.getElementById('webapp')
        );
    </script>
</div>
</body>
</html>