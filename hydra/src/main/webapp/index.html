<!DOCTYPE html>
<!--
  ~ Copyright Dansk Bibliotekscenter a/s. Licensed under GNU GPL v3
  ~  See license text at https://opensource.dbc.dk/licenses/gpl-3.0
  -->

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hydra</title>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/3.6.0/superagent.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>
</head>
<body>
<div id="webapp" class="container-fluid">
    <script>
        const e = React.createElement;

        class RestCall extends React.Component {
            constructor(props) {
                super(props);
                this.queueModeInput = 0;
                this.queueModeValidated = 10;
                this.queueModeProcessing = 20;
                this.queueModeProcessed = 30;

                this.state = {
                    mode: undefined,
                    queueMode: this.queueModeInput,
                    queueAnalysis: undefined,
                    queueChunks: undefined,
                    queueChunkIndex: 0,
                    queueProgress: 0,
                    queueTypes: [],
                    providers: [],
                    selectedQueueType: undefined,
                    selectedAgencies: '',
                    selectedProvider: undefined,
                    includeDeleted: "false",
                    isLoading: false,
                    instanceName: undefined
                };

                this.getQueueTypes = this.getQueueTypes.bind(this);
                this.getLibrariesByCatalogingTemplateSet = this.getLibrariesByCatalogingTemplateSet.bind(this);
                this.getRRProviders = this.getRRProviders.bind(this);
                this.handleQueueValidate = this.handleQueueValidate.bind(this);
                this.handleQueueProcess = this.handleQueueProcess.bind(this);
                this.setQueuePage = this.setQueuePage.bind(this);
                this.setIntrospectPage = this.setIntrospectPage.bind(this);
                this.setUpdatePage = this.setUpdatePage.bind(this);
                this.drawSubPage = this.drawSubPage.bind(this);
                this.drawQueuePage = this.drawQueuePage.bind(this);
                this.onChangeQueueType = this.onChangeQueueType.bind(this);
                this.onChangeProvider = this.onChangeProvider.bind(this);
                this.onChangeIncludeDeleted = this.onChangeIncludeDeleted.bind(this);
                this.onChangeAgencies = this.onChangeAgencies.bind(this);
                this.setDefaultValues = this.setDefaultValues.bind(this);
                this.getProvidersLink = this.getProvidersLink.bind(this);
                this.getSubmitButtonLabel = this.getSubmitButtonLabel.bind(this);
                this.getProcessButtonLabel = this.getProcessButtonLabel.bind(this);
                this.getInstanceName = this.getInstanceName.bind(this);
                this.getHeader = this.getHeader.bind(this);
                this.setQueueModeInput = this.setQueueModeInput.bind(this);
                this.processQueue = this.processQueue.bind(this);
            }


            getQueueTypes() {
                superagent.get("api/library/queueTypes").end((err, res) => {
                    this.setState({queueTypes: JSON.parse(res.text).values}, this.setDefaultValues);
                });
            }

            getLibrariesByCatalogingTemplateSet(value) {
                this.state.catalogingTemplateSet = value;
                superagent.get("api/library/catalogingTemplateSet/" + catalogingTemplateSet).end((err, res) => {
                    this.setState({allowedLibraries: JSON.parse(res.text).values});
                });
            }

            getRRProviders() {
                superagent.get('api/queue/providers').end((err, res) => {
                    this.setState({providers: JSON.parse(res.text).providers}, this.setDefaultValues);
                });
            }

            getInstanceName() {
                superagent.get('api/hydra/instance').end((err, res) => {
                    this.setState({instanceName: JSON.parse(res.text).value})
                });
            }

            getHeader() {
                if (this.state.instanceName === undefined) {
                    this.getInstanceName();
                    return 'RawRepo HYDRA';
                } else {
                    return 'RawRepo HYDRA - ' + this.state.instanceName;
                }
            }

            handleQueueValidate(event) {
                this.setState({isLoading: true});
                let data = JSON.stringify({
                    provider: this.state.selectedProvider,
                    queueType: this.state.selectedQueueType.key !== undefined ? this.state.selectedQueueType.key : this.state.selectedQueueType,
                    includeDeleted: this.state.includeDeleted,
                    agencyText: this.state.selectedAgencies
                });
                superagent
                    .post('api/queue/validate')
                    .send(data)
                    .type('json')
                    .set('Accept', 'application/json')
                    .then((res) => {
                        let response = JSON.parse(res.text);

                        if (response.validated) {
                            this.setState({
                                queueMode: this.queueModeValidated,
                                queueAnalysis: response.analysis,
                                queueChunks: response.chunks
                            });
                        } else {
                            alert('VALIDERING FEJLEDE! \n\n ' +
                                JSON.parse(res.text).message);
                        }
                        this.setState({isLoading: false});
                    })
                    .catch((error) => {
                        alert('FEJL! ' + error);
                        this.setState({isLoading: false});
                    });
                event.preventDefault();
            }

            handleQueueProcess(event) {
                this.setState({isLoading: true, queueMode: this.queueModeProcessing});

                let provider = this.state.selectedProvider;
                let queueType = this.state.selectedQueueType.key !== undefined ? this.state.selectedQueueType.key : this.state.selectedQueueType;
                let includeDeleted = this.state.includeDeleted;
                let agencyText = this.state.selectedAgencies;
                let chunks = this.state.queueChunks;

                this.processQueue(provider, queueType, includeDeleted, agencyText, chunks, 0);

                event.preventDefault();
            }


            processQueue(provider, queueType, includeDeleted, agencyText, chunks, chunkIndex) {
                superagent
                    .post('api/queue/process')
                    .send(JSON.stringify({
                        provider: provider,
                        queueType: queueType,
                        includeDeleted: includeDeleted,
                        agencyText: agencyText,
                        chunk: chunks[chunkIndex]
                    }))
                    .type('json')
                    .set('Accept', 'application/json')
                    .then((res) => {
                        let response = JSON.parse(res.text);

                        if (response.validated) {
                            if (chunkIndex === chunks.length - 1) {
                                this.setState({
                                    queueMode: this.queueModeProcessed,
                                    queueProgress: 100
                                });
                            } else {
                                this.setState({
                                    queueProgress: (chunkIndex + 1) / (chunks.length) * 100
                                });
                                this.processQueue(provider, queueType, includeDeleted, agencyText, chunks, chunkIndex + 1)
                            }
                        } else {
                            alert('VALIDERING FEJLEDE! \n\n ' +
                                JSON.parse(res.text).message);
                            this.setState({
                                queueMode: this.queueModeValidated
                            });
                        }
                        this.setState({isLoading: false});
                    })
                    .catch((error) => {
                        alert('FEJL! ' + error);
                        this.setState({
                            isLoading: false
                        });
                    });
            }

//850160
            onChangeQueueType(event) {
                this.setState({selectedQueueType: event.target.value});
            }

            onChangeProvider(event) {
                this.setState({selectedProvider: event.target.value});
            }

            onChangeIncludeDeleted(event) {
                this.setState({includeDeleted: event.target.value});
            }

            onChangeAgencies(event) {
                this.setState({selectedAgencies: event.target.value});
            }

            setDefaultValues() {
                if (this.state.selectedProvider === undefined && this.state.providers.length > 0) {
                    this.setState({selectedProvider: this.state.providers[0]})
                }

                if (this.state.selectedQueueType === undefined && this.state.queueTypes.length > 0) {
                    this.setState({selectedQueueType: this.state.queueTypes[0]})
                }
            }

            setQueuePage() {
                this.setState({mode: 'QUEUE', queueMode: this.queueModeInput});

                this.getQueueTypes();
                this.getRRProviders();
                this.setDefaultValues();
            }

            setIntrospectPage() {
                this.state.mode = 'INTRO';
            }

            setUpdatePage() {
                this.state.mode = 'UPDATE';
            }

            drawSubPage() {
                if (this.state.mode === 'QUEUE') {
                    return this.drawQueuePage();
                }
            }

            getProvidersLink() {
                if (!this.state.isLoading) {
                    return e('a', {className: "toDoc", href: "providers.html", target: "_blank"}, "Forklaring");
                } else {
                    return e('p', null, "Forklaring");
                }
            }

            getSubmitButtonLabel() {
                if (!this.state.isLoading) {
                    return 'Valider';
                } else {
                    return 'Arbejder...'
                }
            }

            getProcessButtonLabel() {
                if (!this.state.isLoading) {
                    return 'Processer';
                } else {
                    return 'Arbejder...'
                }
            }

            setQueueModeInput() {
                this.setState({
                    queueMode: this.queueModeInput,
                    queueAnalysis: undefined,
                    queueChunks: undefined,
                    queueChunkIndex: 0,
                    queueProgress: 0
                })
            }

            drawQueuePage() {
                return e('div', {className: 'container'},
                    e('h2', null, 'Queue'),
                    e('form', {className: 'form-horizontal', onSubmit: this.handleQueueValidate},
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'select-queue-type',
                                className: 'control-label col-sm-2'
                            }, 'Vælg køtype:'),
                            e('div', {className: 'col-sm-8'},
                                e('select', {
                                        id: 'select-queue-type',
                                        className: 'form-control',
                                        name: 'select-queue-type',
                                        onChange: this.onChangeQueueType,
                                        value: this.state.selectedQueueType,
                                        required: true,
                                        disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                    },
                                    this.state.queueTypes.map(function (item, index) {
                                            return e('option', {key: item.key, value: item.key}, item.description);
                                        }
                                    )
                                )
                            )
                        ),
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'select-provider',
                                className: 'control-label col-sm-2'
                            }, 'Vælg provider:'),
                            e('div', {className: 'col-sm-8'},
                                e('select', {
                                        id: 'select-provider',
                                        className: 'form-control',
                                        name: 'select-provider',
                                        onChange: this.onChangeProvider,
                                        value: this.state.selectedProvider,
                                        required: true,
                                        disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                    },
                                    this.state.providers.map(function (name, index) {
                                            return e('option', {key: index, value: name}, name);
                                        }
                                    )
                                )
                            ),
                            this.getProvidersLink()
                        ),
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'select-deleted',
                                className: 'control-label col-sm-2'
                            }, 'Inkluder slettede poster?'),
                            e('div', {className: 'col-sm-8'},
                                e('select', {
                                        id: 'select-deleted',
                                        className: 'form-control',
                                        name: 'select-deleted',
                                        value: this.state.includeDeleted,
                                        onChange: this.onChangeIncludeDeleted,
                                        required: true,
                                        disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                    },
                                    [e('option', {key: 'delete-yes', value: true}, 'Ja'),
                                        e('option', {key: 'delete-no', value: false}, 'Nej')]
                                )
                            )
                        ),
                        e('div', {className: "form-group"},
                            e('label', {
                                htmlFor: 'agencies-to-queue',
                                className: 'control-label col-sm-2'
                            }, 'Indtast biblioteksnumrene:'),
                            e('div', {className: 'col-sm-8'},
                                e('textarea', {
                                    className: 'form-control',
                                    name: 'agencies-to-queue',
                                    id: 'agencies-to-queue',
                                    rows: 15,
                                    onChange: this.onChangeAgencies,
                                    value: this.state.selectedAgencies,
                                    required: true,
                                    disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                }, null)
                            )
                        ),
                        e('div', {className: 'form-group'},
                            e('div', {className: 'col-sm-offset-2 col-sm-10'},
                                e('button', {
                                    className: 'btn btn-success',
                                    type: 'submit',
                                    disabled: this.state.isLoading || this.state.queueMode >= this.queueModeValidated
                                }, this.getSubmitButtonLabel()),
                                this.state.queueMode >= this.queueModeValidated ? e('button', {
                                    className: 'btn btn-default',
                                    type: 'button',
                                    onClick: this.setQueueModeInput,
                                    disabled: this.state.isLoading || this.state.queueMode >= this.queueModeProcessing
                                }, 'Tilbage') : null
                            )
                        )
                    ),
                    this.state.queueMode >= this.queueModeValidated ?
                        e('div', null,
                            e('hr', null, null),
                            e('h2', null, 'Analyse'),
                            e('form', {className: 'form-horizontal', onSubmit: this.handleQueueProcess},
                                e('div', {className: 'container col-sm-offset-2 col-sm-8'},
                                    e('table', {className: 'table'},
                                        e('thead', null,
                                            e('tr', {key: 'queue-analysis-head'},
                                                e('th', null, 'Biblioteksnummer'),
                                                e('th', null, 'Antal')
                                            )
                                        ),
                                        e('tbody', null,
                                            this.state.queueAnalysis.map(function (item, index) {
                                                return e('tr', {key: 'queue-analysis-' + item.agencyId},
                                                    e('td', null, item.agencyId),
                                                    e('td', null, item.count)
                                                );
                                            })
                                        )
                                    )
                                ),
                                e('div', {className: 'form-group'},
                                    e('div', {className: 'col-sm-offset-2 col-sm-10'},
                                        e('button', {
                                            className: 'btn btn-success',
                                            type: 'submit',
                                            disabled: this.state.isLoading || this.state.queueMode >= this.queueModeProcessing
                                        }, this.getProcessButtonLabel())
                                    )
                                )
                            )
                        ) : null,
                    this.state.queueMode >= this.queueModeProcessing ?
                        e('div', null,
                            e('hr', null, null),
                            e('h2', null, 'Progress: ' + Math.round(this.state.queueProgress) + '%')
                        ) : null,
                    this.state.queueMode === this.queueModeProcessed ?
                        e('div', null,
                            e('hr', null, null),
                            e('h2', null, 'Køpålæggelse færdig!'),
                            e('form', {className: 'form-horizontal', onSubmit: this.setQueueModeInput},
                                e('div', {className: 'form-group'},
                                    e('div', {className: 'col-sm-offset-2 col-sm-10'},
                                        e('button', {
                                            className: 'btn btn-success',
                                            type: 'submit',
                                            disabled: this.state.isLoading
                                        }, "Ny køpålæggelse")
                                    )
                                )
                            )
                        ) : null,
                );
            }

            render() {
                return e('div', null,
                    e('h1', {
                        id: 'h1-div-headline',
                        title: 'Hydra: Multi headed beast guarding the entrance to the Underworld'
                    }, this.getHeader()),
                    e('hr'),
                    e('div', null, 'Vælg venligst en funktion:'),
                    e('button', {
                        id: 'btn-queue',
                        className: "btn btn-success",
                        style: {margin: "10px", display: 'inline-block'},
                        onClick: () => {
                            this.setQueuePage()
                        }
                    }, 'Queue'),
                    e('button', {
                        id: 'btn-introspect',
                        className: "btn btn-success",
                        style: {margin: "10px", display: 'inline-block'},
                        disabled: true,
                        onClick: () => {
                            this.setIntrospectPage()
                        }
                    }, 'Introspect'),
                    e('button', {
                        id: 'btn-update',
                        className: "btn btn-success",
                        style: {margin: "10px", display: 'inline-block'},
                        disabled: true,
                        onClick: () => {
                            this.setUpdatePage()
                        }
                    }, 'Update'),
                    e('hr'),
                    this.drawSubPage());
            }
        }


        ReactDOM.render(
            e(RestCall),
            document.getElementById('webapp')
        );
    </script>
</div>
</body>
</html>